# DM自動集客プロジェクト - 開発履歴・引き継ぎメモ

## プロジェクト概要
「起業サーチDM営業サービス」のランディングページ（LP）および関連システムの開発プロジェクト。

### サービス概要
士業・専門サービスに特化した、全自動の新規開拓ツール。
- **① 自動発見**: 国税庁の法人番号データから、設定エリアの新設法人を毎日自動検索
- **② レポート自動作成**: e-Stat（国勢調査等）のデータをもとに、会社周辺の商圏データレポートを自動生成
- **③ 自動発送**: 設立1週間以内に「開業お祝いの封筒」として自動郵送（1通350円）

### ターゲット
- 税理士、社労士、行政書士などの士業
- 新設法人への営業が有効なサービス提供者

---

## 開発履歴

### 2026-02-18 ── セッション1：LPページ作成

**作業内容:**
- `index.html` を新規作成（LPページ・1ファイル完結型）

**ページ構成（10セクション）:**
1. **ヒーローセクション** - キャッチコピー「設定したら、あとは待つだけ」+ 1通350円の料金訴求 + CTAボタン
2. **お悩みセクション** - ターゲットが抱える5つの悩みをリスト表示
3. **解決策セクション** - サービスが全てを解決できることを説明
4. **3ステップセクション** - 自動発見 → レポート作成 → 自動発送の流れを視覚的に表示
5. **なぜすごいのかセクション** - 開封率・タイミング・手間ゼロ・コストの4つの強みをカード表示
6. **料金セクション** - 350円/通のシンプル料金 + 含まれるもの一覧
7. **比較表** - 従来のDM・営業スタッフ・本サービスの3列比較
8. **お客様の声** - 税理士・社労士・行政書士の3名の声（サンプル）
9. **FAQセクション** - アコーディオン式で5つのQ&A
10. **最終CTAセクション** - お問い合わせへの誘導（現在 mailto:info@example.com）

**デザインの特徴:**
- 温かみのあるオレンジ系のグラデーション配色
- Google Fonts「Zen Maru Gothic」で優しい丸みのある印象
- スマホ対応のレスポンシブデザイン
- 外部画像を使わず、HTML + CSS + 最小限のJSで完結
- FAQはアコーディオン開閉式

**技術構成:**
- HTML / CSS / JavaScript（すべて `index.html` 1ファイルに内包）
- 外部依存: Google Fonts のみ

---

### 2026-02-18 ── セッション2：デザイン全面刷新 + e-Statデモツール追加

**作業内容:**
- `index.html` を全面リライト（デザイン一新 + 新機能追加）

**デザイン変更（高級感・洗練路線へ）:**
- **配色**: オレンジ系 → ダークネイビー（#0d1b2a）+ ゴールドアクセント（#c9a84c）
- **フォント**: Zen Maru Gothic → 「Noto Serif JP」（見出し・上品さ）+「Noto Sans JP」（本文・可読性）
- **レイアウト**: 丸みのあるポップ → 直線的でミニマル、余白を多めに
- **ヒーロー**: ダークネイビー背景 + グリッドパターン + 数値メトリクス表示
- **カード**: 重いシャドウ → 1px境界線のグリッドレイアウト
- **ボタン**: 丸いポップなボタン → 角ばったゴールドボタン
- **ナビ**: 固定ヘッダー追加（スクロールで半透明背景）
- **アニメーション**: IntersectionObserver によるフェードインアニメーション追加
- **FAQ**: 排他的アコーディオン（1つ開くと他が閉じる）

**新機能: 費用シミュレーション（Simulation セクション）:**
- 都道府県ドロップダウン → **フリーワード入力**（オートコンプリート付き）に変更
- 都道府県（47）＋ 主要市区町村（約150）をサジェスト候補に
- 市区町村は都道府県データ × 人口/事業所シェア比率で推計
- **月額費用シミュレーション表示**: 月間新設法人数 × 350円
- **ヒーロー直後に配置**（セクション順変更）
- 表示: 月額費用目安（メイン）、月間新設法人数、事業所数、年間新設数、開業率、業種別バーチャート
- キーボード操作対応（↑↓キーで候補選択、Enter で確定）

**テキスト変更:**
- ヒーローバッジ: 「士業・専門サービスに特化した〜」→「特に税理士、社労士、コンサル事業者様に全自動営業システム」
- 解決策セクション: 「士業・専門サービスのために」→「税理士・社労士・コンサル事業者のために」

---

### 2026-02-18 ── セッション3：レポート修正・区データ追加・予算上限機能

**修正1: A4レポート1枚収まり+データ中心化:**
- フォントサイズ・padding全体を縮小しA4比率内に確実に収める
- **新データ追加**: 1人あたり食費（¥47,800/月）、商業地坪単価（628万/坪）、平均年収（654万）、昼夜間人口比（221%）
- 年齢構成の円グラフ → 消費支出内訳の棒グラフ（食料・住居・交通通信・教養娯楽・教育）に変更
- 近隣比較テーブルに坪単価・食費/人を追加
- AI分析コメントを食費・坪単価に言及するデータドリブンな内容に短縮

**修正2: 政令指定都市の区データ追加（名古屋市天白区等）:**
- 以下の政令指定都市の全区を追加（約160区）:
  - 札幌市(10区)、仙台市(5区)、さいたま市(10区)、千葉市(6区)
  - 川崎市(7区)、横浜市(18区)、相模原市(3区)、新潟市(8区)
  - 静岡市(3区)、浜松市(3区)、名古屋市(16区)、京都市(11区)
  - 大阪市(24区)、堺市(7区)、神戸市(9区)、岡山市(4区)
  - 広島市(8区)、北九州市(7区)、福岡市(7区)、熊本市(5区)
- 同名区の重複対策: サジェストに親市名を付与（例: 「名古屋市天白区 愛知県」）
- wardParents逆引きマップで自動解決

**追加: 月額上限設定（安心価格制限）:**
- シミュレーション結果の下に「月額上限を設定」入力欄（デフォルト¥10,000）
- 予算に応じた月間送付通数を即座に表示
- 全新設法人に届く場合は「全てお届けできます」メッセージ
- 超える場合は「月XX通まで（¥XX,XXX）。予算を超えることはありません。」

**追加: 機能バッジ:**
- シミュレーション内に4つの機能バッジ表示:
  「月額上限設定で安心」「複数エリア対応」「除外フィルター」「業種指定」

**ページ構成（13セクション）:**
1. ナビゲーション → 2. ヒーロー → 3. 費用シミュレーション（予算上限付き）
4. お悩み → 5. 解決策 → 6. 3ステップ → 7. **レポートサンプル（渋谷区A4）**
8. なぜ選ばれるか → 9. 料金 → 10. 比較表
11. お客様の声 → 12. FAQ → 13. 最終CTA

### 2026-02-18 ── セッション4：全1,741市区町村の完全網羅

**全自治体データの追加（3つのデータオブジェクト）:**
- `AM`: 全国792市（都道府県別パイプ区切り）
- `AT`: 全国743町（都道府県別パイプ区切り）
- `AV`: 全国183村（都道府県別パイプ区切り）
- Cに含まれない自治体はAM/AT/AVから自動補完

**重み付きシェア配分:**
- Cでカバー済みシェアの残りを、市(weight3)・町(weight1)・村(weight0.5)の重みで配分
- 市は町・村より大きなシェアが割り当てられ、より現実的な推計に

**カバー範囲（完全網羅）:**
- 都道府県: 47件
- 市: 792件
- 町: 743件
- 村: 183件
- 政令指定都市の区: 約160件（20市全区）
- 東京23特別区: 23件
- **合計: 1,741市区町村 + 47都道府県 = 全自治体対応**

**バグ修正: 東京都の区名表示（"東京都名古屋市港区" 問題）:**
- 原因: ward（区）の親市名検索で `||cities[0]` というフォールバックがあり、東京23区のように政令指定都市に属さない特別区で、リスト先頭の都市名（名古屋市）が誤表示されていた
- 修正: `||cities[0]` を削除。親市が見つからない場合はundefinedとし、区名のみを表示
- 結果: 「東京都 港区」と正しく表示されるようになった（名古屋市港区は「愛知県 名古屋市港区」と正しく区別）

**A4レポート: 比較表への刷新:**
- 業界別事業所構成の単一棒グラフ → 4列比較表（対象地域 vs 近隣 vs 都道府県 vs 全国）に変更
- 消費支出内訳の単一棒グラフ → 同様の4列比較表に変更
- CSSクラス `.rp-comp` で比較表スタイリング
- ハイライト: `.hi`（ゴールド・最大値）、`.lo`（グレー・最小値）
- AI分析コメントも比較データに基づく内容に更新

**フッターに会社情報追加:**
- 〒468-0015 愛知県名古屋市天白区原3丁目304番1号
- 株式会社バンテックス

**GitHub Pages デプロイ:**
- リポジトリ: `makoban/kigyo_DM`
- カスタムドメイン: `kigyo-dm.bantex.jp`
- CNAMEファイル作成（内容: kigyo-dm.bantex.jp）
- DNS設定（ユーザー側）: `kigyo-dm.bantex.jp` → CNAME → `makoban.github.io.` TTL:10800
- GitHub Pages有効化（mainブランチ / root）
- HTTPS: DNS伝播後に手動で有効化が必要（Settings → Pages → Enforce HTTPS）

**レスポンシブ対応の全面改修（3回の修正を経て完成）:**

初期実装で `word-break:keep-all` を追加したが、日本語テキストの折り返しを完全に阻止してしまい横スクロールの根本原因に。3回の修正で解決。

- **横スクロール根本修正**: `word-break:keep-all` → `word-break:normal` に変更
  - `keep-all` は日本語テキストの自動折り返しを阻止し、狭い画面でコンテナからはみ出す原因だった
  - `word-break:normal` で日本語は文字単位で自然に折り返される
  - `overflow-wrap:break-word` は安全策として維持
- `html` に `overflow-x:hidden` 追加（ページレベルの横スクロール防止）
- `.bp` クラス: PC用 `<br>` タグ。768px以下で `display:none` に切り替え
- `.table-scroll` クラス: テーブルの横スクロール防止ラッパー（`overflow-x:auto`）
- 比較表（`.compare-table`）を `.table-scroll` で囲み
- `.report-desc` の `min-width:260px` → `0` に変更（溢れ防止）
- `.report-preview-wrap` に `max-width:100%` 追加
- **768pxブレークポイント:**
  - `*{max-width:100%;box-sizing:border-box}` で全要素の溢れ完全防止
  - ナビリンク非表示、hero h1/sub の `<br>` 非表示、hero-divider 非表示
  - フォント縮小: h1→1.3rem、section-title→1.2rem、本文→.75-.82rem
  - voice-card テキストをセンタリング
  - compare-table に `table-layout:fixed` 追加
  - カードグリッド系（3列→1列）: `.pain-grid`, `.why-grid`, `.voice-grid`
  - ボタン `width:100%` で全幅表示
- **480pxブレークポイント:**
  - フォントをさらに大幅縮小（h1→1.05rem、本文→.68-.72rem）
  - container padding: 12px、sim-card padding: 18px 10px
  - step-number: 36px（PC版64px→36px）
  - 全UI要素を極小画面向けに最適化

**教訓**: 日本語サイトで `word-break:keep-all` は使ってはいけない。デスクトップでは問題なく見えるが、モバイルの狭い画面でテキストが折り返せずオーバーフローする。

### 2026-02-18 ── セッション5：キャッチコピー刷新 + 特定商取引法ページ追加

**ヒーローキャッチコピーの変更:**
- **メインコピー（h1）**:
  - 旧: 「設定したら、あとは待つだけ。起業直後の社長へ "捨てられない手紙"を全自動で届ける」
  - 新: 「起業したての会社へ、いちばん最初に届く一通。」（「一通」をゴールドで強調）
- **サブコピー（hero-sub）**:
  - 旧: 「リスト作成・レポート作成・封入・発送まで、すべてシステムにおまかせ。あなたは本業に集中するだけで、新規顧問先が届きます。」
  - 新: 「商圏データなどの「有益な情報」を添えるから、捨てられずに読まれる。貴所の新たな営業の柱となる、新設法人向けの全自動DMサービスです。」（「全自動DMサービス」をゴールドで強調）
- **titleタグ**: 同様に新コピーに変更
- **解決策セクションのハイライト**: 同様に新コピーに統一

**特定商取引法に基づく表記ページ（`tokushoho.html`）の新規作成:**
- Stripe決済導入に必要な法定表記ページ
- メインサイトと同じダークネイビー＋ゴールドのデザインで統一
- レスポンシブ対応（768px以下でテーブルがブロック表示に切替）
- URL: `https://kigyo-dm.bantex.jp/tokushoho.html`
- **記載情報:**
  - 販売業者: 株式会社バンテックス
  - 代表責任者: 番野政彦
  - 所在地: 〒468-0015 愛知県名古屋市天白区原3丁目304番1号
  - 電話番号: 052-847-7501
  - メールアドレス: info@bantex.jp
  - 販売価格: 1通350円（税込・全込み）
  - 支払方法: クレジットカード決済（従量制）
  - 支払時期: 都度決済、または月締め後払い
  - サービス提供時期: 即日
  - 解約: いつでも即時解約可、手数料なし
  - 返品・キャンセル: 発送済みDMは不可
  - 追加手数料: なし（サポート無料・専用LINE対応）

**index.html フッターにリンク追加:**
- 「特定商取引法に基づく表記」へのリンクを会社情報とコピーライトの間に設置

---

### 2026-02-27 ── セッション6：HTTPS強制化 + LP改善 + プリペイド課金への全面移行

**1. HTTPS強制化:**
- GitHub Pages API経由で `https_enforced: true` に設定完了
- `https://kigyo-dm.bantex.jp` が常時SSL接続に（セッション4で「DNS伝播後に手動で有効化が必要」と記録していた作業を完了）

**2. LP改善（index.html）:**
- **OGPメタタグ追加**: `og:title`, `og:description`, `og:image`, `twitter:card` を追加（SNSシェア時の表示に対応）
- **SVGファビコン追加**: `favicon.svg`（ネイビー背景 + ゴールド「起」文字）をHTMLに `<link rel="icon">` で設定
- **最終CTAセクションにLINEボタン追加**: https://lin.ee/5b8JT4C
- **フッターにもLINEリンク追加**

**3. 特商法ページ更新（tokushoho.html）:**
セッション6でのプリペイドチャージ型課金への移行に伴い、以下の記載を更新:
- **お支払方法**: クレジットカード（従量制） → 毎月自動チャージ制（スタート/スタンダード/プロ/フルの4プラン）
- **お支払時期**: 都度決済または月締め後払い → 初回即時 + 毎月1日自動チャージ
- **解約**: いつでも即時解約可 → 当月末でチャージ停止の文言を追記
- **返品・キャンセル**: 発送済みDMは不可 → 残高返金不可・30日間猶予後失効を追記

**4. プリペイドチャージ型課金への全面移行（webapp/）:**

課金モデルの変更:
- **変更前**: 月末後払い（SetupIntent + 月末バッチ請求）
- **変更後**: プリペイドチャージ型（Stripe Subscription + 残高管理）
- **理由**: 立替ゼロ・未収リスクゼロ・Stripe手数料最小

4プラン定数（src/lib/stripe.ts に追加）:
| プラン | 月額 | 通数 |
|--------|------|------|
| スタート | 3,800円 | 10通 |
| スタンダード | 7,600円 | 20通 |
| プロ | 15,200円 | 40通 |
| フル | 38,000円 | 100通 |

DB変更（002_prepaid_billing.sql 新規作成）:
- `profiles`: `balance`, `stripe_subscription_id`, `plan_amount` カラム追加
- `mailing_queue`: `balance_deducted` カラム追加
- `monthly_usage`: `payment_status` に `'charged'` を追加

新規API:
- `/api/stripe/create-subscription`: Subscription作成（初回即時チャージ）
- `/api/stripe/change-plan`: プラン変更（翌月1日反映）

改修API:
- `/api/stripe/complete-setup`: SetupIntent検証削除、sender + subscription保存のみに簡略化
- `/api/stripe/webhook`: `invoice.paid` → 残高加算、`payment_failed` → 停止、`subscription.deleted` → 解約
- `/api/cron/monthly-billing`: 月末請求 → 毎日残高減算に変更（sent + 未精算アイテムを検索して減算）

オンボーディング改修:
- `budget/page.tsx`: 自由入力 → 4プランカード選択UIに変更
- `payment/page.tsx`: SetupIntent → Subscription作成 + PaymentIntent決済に変更
- `complete/page.tsx`: `setupIntentId` → `planAmount` に変更
- `onboarding-store.ts`: `monthlyBudgetLimit` → `planAmount` に変更

ダッシュボード改修:
- `dashboard/page.tsx`: 月額上限 → 残り通数・残高表示に変更
- `settings/page.tsx`: 月額上限入力 → 4プラン選択UI + プラン変更API呼び出しに変更
- `billing/page.tsx`: 請求履歴 → チャージ・送付履歴に変更、残高表示追加

型定義更新（types.ts）:
- `Profile`: `balance`, `stripe_subscription_id`, `plan_amount` 追加
- `MailingQueueItem`: `balance_deducted` 追加
- `MonthlyUsage`: `payment_status` に `'charged'` 追加

**ビルド結果**: 全29ルート ビルド成功・型エラーなし（セッション5終了時の27ルートから2ルート増加）

---

**今後の課題・TODO（未着手）:**
- [ ] お問い合わせフォームの実装（現在は mailto リンクのみ）
- [ ] 実際のお客様の声への差し替え（現在はサンプルテキスト）
- [ ] メールアドレス `info@example.com` を実際のアドレスに変更
- [x] OGP（SNSシェア用）メタタグの追加（セッション6で完了）
- [ ] Google Analytics 等のアクセス解析タグの設置
- [x] ファビコンの設定（セッション6でSVGファビコン追加）
- [x] 独自ドメインでのホスティング・公開（GitHub Pages + kigyo-dm.bantex.jp）
- [x] HTTPS強制（セッション6でGitHub Pages API経由で設定完了）
- [ ] e-Stat リアルAPI接続（現在はJSに内包した参考データ）
- [ ] モバイルメニュー（ハンバーガー）の実装
- [ ] Stripe に Product + 4 Price 作成（テストモード → 本番）
- [ ] DB: 002_prepaid_billing.sql を Supabase 本番環境に適用
- [ ] ダッシュボードの表示を通数ベースに本番確認

---

## ファイル構成

```
DM自動集客/
├── index.html           ... LPページ（メインファイル）
├── tokushoho.html       ... 特定商取引法に基づく表記ページ
├── CNAME                ... GitHub Pagesカスタムドメイン設定（kigyo-dm.bantex.jp）
├── CLAUDE.md            ... このファイル（開発履歴・引き継ぎメモ）
└── webapp/              ... SaaSアプリ（Next.js 16）
    ├── supabase/migrations/
    │   ├── 001_initial_schema.sql
    │   └── 002_prepaid_billing.sql  ... プリペイド課金スキーマ（セッション6追加）
    ├── src/app/api/stripe/
    │   ├── create-subscription/route.ts  ... Subscription作成（セッション6新規）
    │   ├── change-plan/route.ts          ... プラン変更（セッション6新規）
    │   ├── complete-setup/route.ts       ... セッション6改修
    │   ├── setup-intent/route.ts
    │   └── webhook/route.ts             ... セッション6改修
    └── src/app/api/cron/
        └── monthly-billing/route.ts     ... セッション6改修（残高減算に変更）
```

---

## メモ・申し送り事項
- ページは1ファイル完結型なので、`index.html` をブラウザで直接開けば確認可能
- 配色はダークネイビー＋ゴールド系（メイン: #0d1b2a、アクセント: #c9a84c）
- フォントは「Noto Serif JP」（見出し）+「Noto Sans JP」（本文）
- CSS変数（カスタムプロパティ）でデザイントークンを管理
- シミュレーションのデータは JS 内に静的に埋め込み
  - 都道府県: 47件（経済センサス-基礎調査 + 中小企業白書ベース）
  - 市: 792件（AM）、町: 743件（AT）、村: 183件（AV）→ 全1,741自治体を完全網羅
  - 政令指定都市区+東京23区: 約180件（Cに個別シェア設定済み）
  - Cにない自治体は重み付き配分（市3:町1:村0.5）で都道府県残シェアを按分
  - 費用計算: `月額 = Math.round(年間新設法人数 × share / 12) × 350`
  - 将来的にリアルAPI接続する場合は `selectLocation()` → `showResult()` を改修
